---
title: "Homework 6"
author: "Gauri Bhatkhande"
date: "09/12/2020"
output: github_document
editor_options: 
  chunk_output_type: console
---

```{r}
library(tidyverse)
library(modelr)
library(mgcv)
```

## Problem 2

**Importing the dataset**
```{r}
birthweight_data = read_csv(file = "./data/birthweight.csv")
```

**Cleaning the dataset** 

```{r}
birthweight_data %>%
  sapply(function(x) sum(is.na(x))) 

birthweight_df = 
  birthweight_data %>%
  mutate(
    babysex = as.factor(babysex) 
  )

```


**Proposed regression model for the outcome birthweight.** 

Based on hypothesis found in literature, I have selected the following variables as predictors: 
Mother's weight gain during pregnancy (pounds) (wtgain)
Gestational age in weeks (gaweeks)
Babyâ€™s sex (babysex)

This model was decided based on literature evidence that suggested an association between these predictors and the baby's birthweight. 

However, before building the regression model, we assume linearity and hence it is necessary to make a scatterplot to see if the outcome and predictor are linearly related. 

**Making a scatterplot** 

```{r}
ggplot(birthweight_df, aes(x = wtgain, y = bwt, color = babysex)) + 
  geom_point() +
  geom_smooth(se = FALSE)


ggplot(birthweight_df, aes(x = gaweeks, y = bwt, color = babysex)) + 
  geom_point() +
  geom_smooth(se = FALSE)

```

It appears that there could be a linear relationship among the predictors Mother's weight and Gestational age when stratified by Baby's sex. Therefore I also decided to include the interaction term. 

**Building the proposed model:** 

```{r}
lin_model = lm(bwt ~ wtgain*gaweeks*babysex, data = birthweight_df)

lin_model %>%
  broom::tidy() %>% 
  select(term, estimate, p.value) %>% 
  mutate(term = str_replace(term, "babysex2", "baby's sex: female")) %>% 
  knitr::kable(digits = 3)
```

```{r}
birthweight_df %>% 
  modelr::add_residuals(lin_model) %>% 
  modelr::add_predictions(lin_model) %>%
  ggplot(aes(x = pred, y = resid)) + geom_point()
```

**Buiding the other two models:**

Model 2: 

```{r}
lin_model2 = lm(bwt ~ blength + gaweeks, data = birthweight_df)

lin_model2 %>%
  broom::tidy() %>% 
  select(term, estimate, p.value) %>% 
  knitr::kable(digits = 3)
```

Model 3: 

```{r}
lin_model3 = lm(bwt ~ bhead*blength*babysex, data = birthweight_df)

lin_model3 %>%
  broom::tidy() %>% 
  select(term, estimate, p.value) %>% 
  mutate(term = str_replace(term, "babysex2", "baby's sex: female")) %>% 
  knitr::kable(digits = 3)
```

Fit the three models 

```{r}

lin_model = lm(bwt ~ wtgain*gaweeks*babysex, data = birthweight_df)
lin_model2 = lm(bwt ~ blength + gaweeks, data = birthweight_df)
lin_model3 = lm(bwt ~ bhead*blength*babysex, data = birthweight_df)

```

**Cross validation**

```{r}
cv_df = 
  crossv_mc(birthweight_df, 100) 


cv_df =
  cv_df %>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble))
```

```{r}
cv_df = 
  cv_df %>% 
  mutate(
    lin_model  = map(train, ~lin_model),
    lin_model2  = map(train, ~lin_model2),
    lin_model3  = map(train, ~lin_model3)
    )%>% 
  mutate(
    rmse_lin_model  = map2_dbl(lin_model, test, ~rmse(model = .x, data = .y)),
    rmse_lin_model2 = map2_dbl(lin_model2, test, ~rmse(model = .x, data = .y)),
    rmse_lin_model3 = map2_dbl(lin_model3, test, ~rmse(model = .x, data = .y))
    )

cv_df %>% 
  select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") %>% 
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + geom_violin()
```


## Problem 3

```{r}
weather_df = 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2017-01-01",
    date_max = "2017-12-31") %>%
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) %>%
  select(name, id, everything())
```

